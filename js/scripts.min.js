var app=angular.module("stories",[]);app.layout={};app.layout.autoFitTextArea=function(){$(".item textarea").each(function(){$(this).css("overflow","hidden");app.layout.adjustTextAreaHeight(this)})};app.layout.adjustTextAreaHeight=function(a){$(a).height(24);$(a).height($(a).prop("scrollHeight")+12)};$(document).ready(app.layout.autoFitTextArea);app.assignees={};app.assignees.createNewAssignee=function(a){return{name:a}};
app.assignees.addAssignee=function(a,b){if(a&&0<a.length){var c=!1,d;for(d in a)a[d].name===b.name&&(c=!0);c||a.push(b)}else a=[b];return a};
function StoryController(a,b,c){a.stories=b.getStories();a.assignees=b.getAssignees();a.orderProp="-time";a.resetFilter=function(){a.filterProp=""};a.newStory=app.stories.storyTemplate;a.newStory.add=function(){a.newStory.name&&0<a.newStory.name.length&&(a.stories=app.stories.createStory(a.stories,a.newStory,b,c),a.newStory.hidden=!0)};a.deleteStory=function(d){app.stories.deleteStory(a.stories,d,b)};a.$watch("stories",function(){a.tasksUndone=app.tasks.getTasksForLevel(a.stories,0);a.tasksProgressing=
app.tasks.getTasksForLevel(a.stories,1);a.tasksResolved=app.tasks.getTasksForLevel(a.stories,2);a.tasksDone=app.tasks.getTasksForLevel(a.stories,3)},!0);a.getRemainingTime=function(a){return app.stories.getRemainingTime(a)};a.changeStoryState=function(d){app.stories.changeStoryState(a.stories,d,b)};a.newStory.triggerDialog=function(){app.helpers.triggerHidden(a.newStory)};a.newTask=app.tasks.taskTemplate;a.taskTargets=app.tasks.taskTargets;a.handleDragFromState=function(b){app.tasks.handleDragFromState(a.taskTargets,
b)};a.handleResetDragState=function(){for(var b in a.taskTargets)a.taskTargets[b].hidden=!0};a.newTask.triggerDialog=function(b){app.helpers.triggerHidden(a.newTask);!1===a.newTask.hidden&&(a.newTask.storyId=b.id)};a.newTask.add=function(){a.newTask.title&&0<a.newTask.title.length&&(app.tasks.createNewTask(a.stories,a.newTask,a.assignees,b,c),a.newTask.hidden=!0)};a.deleteTask=function(c,e){app.tasks.deleteTask(a.stories,c,e,b)};a.changeTaskState=function(c,e,f){app.tasks.changeTaskState(a.stories,
c,e,f,b)};a.taskUpdated=function(c){app.layout.adjustTextAreaHeight("#task"+c.id+" textarea");b.setStories(a.stories)};a.taskEstimateUpdated=function(){b.setStories(a.stories)}}StoryController.$inject=["$scope","storageService","sequenceNumberService"];app.task={};
app.directive("draggable",function(){return function(a,b){var c=b[0];c.draggable=!0;c.addEventListener("dragstart",function(b){b.dataTransfer.effectAllowed="copy";b.dataTransfer.setData("text/plain",this.id);$(".task-drop-target").height($(c).height()+20);$(".task-drop-target").css("top",$(c).position().top-2);a.$apply("handleDragFromState("+a.task.status+")");return!1},!1);c.addEventListener("dragend",function(b){a.$apply("handleResetDragState()");var c=parseInt($("body").width(),10);a.$apply("changeTaskState("+
a.$parent.story.id+","+a.$index+","+app.helpers.getStatusFromOffset(c,b.screenX)+")");return!1},!1)}});
app.directive("droppable",function(){return function(a,b){var c=b[0];c.addEventListener("dragover",function(a){a.preventDefault&&a.preventDefault();a.dataTransfer.dropEffect="copy";return!1},!1);c.addEventListener("dragenter",function(a){return!1},!1);c.addEventListener("dragleave",function(a){},!1);c.addEventListener("drop",function(a){a.stopPropagation()&&a.stopPropagation();a.preventDefault()&&a.preventDefault();return!1},!1)}});app.helpers={};
app.helpers.triggerHidden=function(a){a.hidden=!1===a.hidden;return a};app.helpers.simpleBenchmark=function(){var a;return{start:function(){a=(new Date).getTime()},stop:function(){var b=(new Date).getTime()-a;console.log("Elapsed time: "+b+"ms");return b}}}();app.helpers.getStatusFromOffset=function(a,b){var c=a/3;return b>=c&&b<=2*c?1:b>=2*c?2:0};app.helpers.sleep=function(a){var b=new Date,c=null;do c=new Date;while(c-b<a)};
app.provider("sequenceNumberService",function(){this.$get=function(){return{getSequenceNumber:function(){var a=parseInt(window.localStorage.getItem("sequenceNumber"),10);a||(a=1);window.localStorage.setItem("sequenceNumber",a+1);return a+1}}}});
app.provider("storageService",function(){this.$get=function(){return{getStories:function(){return JSON.parse(window.localStorage.getItem("persistedData"))},setStories:function(a){window.localStorage.setItem("persistedData",JSON.stringify(a))},getAssignees:function(){return JSON.parse(window.localStorage.getItem("persistedAssignees"))},setAssignees:function(a){window.localStorage.setItem("persistedAssignees",JSON.stringify(a))}}}});app.stories={};
app.stories.storyTemplate={hidden:!0,name:"",priority:1,time:(new Date).getTime()};app.stories.createStory=function(a,b,c,d){b={id:d.getSequenceNumber(),name:b.name,priority:b.priority,time:b.time,state:"expanded"};a=app.stories.addStory(a,b);c.setStories(a);return a};app.stories.addStory=function(a,b){a&&0<a.length?a.push(b):a=[b];return a};app.stories.deleteStory=function(a,b,c){for(var d in a)a[d].id===b.id&&a.splice(d,1);c.setStories(a)};
app.stories.changeStoryState=function(a,b,c){"expanded"===b.state?b.state="collapsed":"collapsed"===b.state&&(b.state="expanded");c.setStories(a)};app.stories.getStoryById=function(a,b){for(var c in a)if(a[c].id===b)return a[c];return null};app.stories.getRemainingTime=function(a){var b=0;if(a.hasOwnProperty("tasks"))for(var c in a.tasks)b+=parseInt(a.tasks[c].estimate,10);return b};app.tasks={};app.tasks.taskTemplate={hidden:!0,storyId:null,title:"",assignee:"",estimate:1,status:0,time:(new Date).getTime()};
app.tasks.taskTargets={targetToDo:{hidden:!0},targetProgress:{hidden:!0},targetResolved:{hidden:!0}};app.tasks.createNewTask=function(a,b,c,d,e){b={id:e.getSequenceNumber(),storyId:b.storyId,title:b.title,assignee:b.assignee,estimate:b.estimate,status:b.status,time:b.time};app.tasks.addTaskToStories(a,b);d.setStories(a);a=app.assignees.createNewAssignee(b.assignee);c=app.assignees.addAssignee(c,a);d.setAssignees(c)};
app.tasks.addTaskToStories=function(a,b){var c=app.stories.getStoryById(a,b.storyId);c.hasOwnProperty("tasks")?c.tasks.push(b):c.tasks=[b]};app.tasks.deleteTask=function(a,b,c,d){app.stories.getStoryById(a,b.storyId).tasks.splice(c,1);d.setStories(a)};app.tasks.changeTaskState=function(a,b,c,d,e){app.stories.getStoryById(a,b).tasks[c].status=d;e.setStories(a)};
app.tasks.handleDragFromState=function(a,b){0===b?(a.targetProgress.hidden=!1,a.targetResolved.hidden=!1):1===b?(a.targetToDo.hidden=!1,a.targetResolved.hidden=!1):2===b&&(a.targetToDo.hidden=!1,a.targetProgress.hidden=!1)};app.tasks.getTasksForLevel=function(a,b){var c=0,d;for(d in a)if(a[d].hasOwnProperty("tasks")){var e=a[d].tasks,f;for(f in e)e[f].status===b&&c++}return c};